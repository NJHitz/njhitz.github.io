<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Team Schedule | NJ Hitz Softball</title>
  <meta name="description" content="Live schedule, results, and record for NJ Hitz Softball teams powered by GameChanger." />
  <meta name="image" content="https://njhitz.org/images/hitz-meta-og.png" />

  <meta property="og:type" content="website">
  <meta property="og:url" content="https://njhitz.org/schedule">
  <meta property="og:title" content="Team Schedule | NJ Hitz Softball">
  <meta property="og:description" content="View your NJ Hitz team schedule, results, and record.">
  <meta property="og:image" content="https://njhitz.org/images/hitz-meta-og.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Team Schedule | NJ Hitz Softball">
  <meta name="twitter:description" content="View your NJ Hitz team schedule, results, and record.">
  <meta name="twitter:image" content="https://njhitz.org/images/hitz-meta-og.png">

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />

  <link href="css/main.css" rel="stylesheet">

  <style>
    .page-shell{
      max-width:1100px;
      margin:0 auto;
      padding:26px 16px 40px;
    }
    .page-header{
      display:flex;
      flex-wrap:wrap;
      gap:18px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:18px;
    }
    .page-title{
      font-size:clamp(26px,3vw,34px);
      margin:0;
    }
    .page-subtitle{
      margin:4px 0 0;
      font-size:.96rem;
      color:#d7d7e2;
    }

    .record-card{
      padding:12px 16px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:radial-gradient(circle at top left,rgba(179,139,53,.14),rgba(20,20,30,.96));
      min-width:180px;
    }
    .record-label{
      font-size:.78rem;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#e9d9b0;
      margin-bottom:4px;
    }
    .record-value{
      font-size:1.7rem;
      font-weight:900;
      line-height:1;
    }
    .record-meta{
      font-size:.8rem;
      color:#d7d7e2;
      margin-top:4px;
    }

    /* LIVE highlight card */
    .live-card-link {
        text-decoration: none;
    }
    .live-card{
      padding:12px 16px;
      border-radius:14px;
      border:1px solid rgba(255,115,140,.9);
      background:radial-gradient(circle at top left,rgba(255,115,140,.16),rgba(25,10,20,.98));
      min-width:200px;
      display:none;
    }
    .live-label{
      font-size:.78rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:#ff9fb4;
      margin-bottom:6px;
      font-weight:bold;
    }
    .live-label-live {
        vertical-align: top;
    }
    .live-opponent{
      font-size:.95rem;
      font-weight:700;
      margin-bottom:4px;
    }
    .live-score{
      font-size:1.05rem;
      font-weight:800;
    }

    .schedule-section{
      margin-top:10px;
      position:relative;
    }
    .schedule-status{
      font-size:.9rem;
      color:#d7d7e2;
      padding:10px 0;
    }

    /* Top filter toolbar (desktop + mobile) */
    .filter-toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin:4px 0 8px;
    }
    .filter-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(12,12,20,1);
      padding:4px 10px;
      font-size:.78rem;
      cursor:pointer;
    }
    .filter-chip span{
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .filter-chip svg{
      width:14px;
      height:14px;
    }
    .hide-past-toggle{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:.8rem;
      color:#d7d7e2;
    }
    .hide-past-toggle input{
      margin:0;
    }

    .schedule-table-wrapper{
      margin-top:8px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
      background:rgba(12,12,18,.96);
      position:relative;
    }
    table.schedule-table{
      width:100%;
      border-collapse:collapse;
      font-size:.88rem;
      table-layout:fixed;
    }
    .schedule-table thead{
      background:rgba(20,20,30,.98);
    }
    .schedule-table th,
    .schedule-table td{
      padding:10px 12px;
      text-align:left;
      border-bottom:1px solid rgba(255,255,255,.05);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .schedule-table tbody tr:last-child td{
      border-bottom:none;
    }
    .schedule-table th{
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.09em;
      color:#c7c7d8;
    }

    .th-label{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
    }
    .filter-toggle{
      border:none;
      background:transparent;
      padding:0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      opacity:.8;
    }
    .filter-toggle:hover{
      opacity:1;
    }
    .filter-toggle svg{
      width:14px;
      height:14px;
    }

    .result{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:24px;
      padding:2px 6px;
      border-radius:999px;
      font-size:.75rem;
      font-weight:700;
      border:1px solid transparent;
      margin-right:4px;
    }
    .result-W{
      background:rgba(25,135,84,.14);
      border-color:rgba(35,185,110,.8);
      color:#a6f2c5;
    }
    .result-L{
      background:rgba(220,53,69,.14);
      border-color:rgba(255,94,110,.9);
      color:#ffd2d7;
    }
    .result-T{
      background:rgba(108,117,125,.16);
      border-color:rgba(158,167,175,.9);
      color:#e6ecf2;
    }
    .score{
      font-size:.8rem;
      opacity:.9;
    }

    /* LIVE badge + row */
    .live-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:.7rem;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.08em;
      background:rgba(220,53,69,.2);
      color:#ffccd7;
      border:1px solid rgba(255,115,140,.9);
      margin-right:4px;
    }
    .live-row{
      position:relative;
      background:radial-gradient(circle at left,rgba(255,115,140,.08),rgba(12,12,18,1));
      box-shadow:0 0 0 1px rgba(255,115,140,.35);
    }
    .live-row .schedule-mobile-primary{
      color:#ffccd7;
    }

    .live-score-desktop,
    .live-score-mobile{
      display:inline-flex;
      align-items:baseline;
      gap:4px;
    }
    .score-animate{
      animation:scorePulse 0.5s ease-out;
    }
    @keyframes scorePulse{
      0%{transform:scale(1);}
      40%{transform:scale(1.35);}
      100%{transform:scale(1);}
    }

    .filter-panel{
      position:fixed;
      z-index:40;
      min-width:220px;
      max-width:260px;
      max-height:300px;
      overflow:auto;
      background:rgba(14,14,22,.98);
      border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 18px 40px rgba(0,0,0,.65);
      padding:10px 10px 12px;
      display:none;
    }
    .filter-panel-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }
    .filter-panel-header span{
      font-size:.76rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#c7c7e0;
    }
    .filter-panel-close{
      border:none;
      background:transparent;
      color:#c7c7e0;
      cursor:pointer;
      font-size:14px;
      padding:0 2px;
    }
    .filter-panel-body{
      font-size:.82rem;
      color:#e8e8f5;
    }
    .filter-panel-body input[type="text"]{
      width:100%;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(8,8,16,1);
      color:#f5f5ff;
      font-size:.8rem;
      margin-bottom:6px;
    }

    .filter-actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:6px;
    }
    .filter-actions button{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(10,10,18,1);
      color:#f5f5ff;
      font-size:.75rem;
      padding:3px 6px;
      cursor:pointer;
      white-space:nowrap;
    }
    .filter-actions button:hover{
      background:rgba(30,30,40,1);
    }

    .filter-options{
      display:flex;
      flex-direction:column;
      gap:4px;
      max-height:220px;
      overflow:auto;
    }
    .filter-option{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:.8rem;
      cursor:pointer;
    }
    .filter-option input{
      margin:0;
    }

    /* Mobile list alternative */
    .schedule-mobile{
      display:none;
      margin-top:8px;
    }
    .schedule-mobile-list{
      list-style:none;
      margin:0;
      padding:0;
    }
    .schedule-mobile-item{
      border-radius:10px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(12,12,18,.96);
      padding:8px 10px;
      margin-bottom:8px;
    }
    .schedule-mobile-btn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      background:transparent;
      border:none;
      color:inherit;
      text-align:left;
      padding:0;
      cursor:pointer;
    }
    .schedule-mobile-main{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .schedule-mobile-primary{
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#c7c7d8;
    }
    .schedule-mobile-opponent{
      font-size:.95rem;
      font-weight:600;
      text-transform: none;
    }
    .schedule-mobile-arrow{
      font-size:1.2rem;
      opacity:.6;
    }

    /* Modal styles */
    .schedule-modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.65);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:60;
    }
    .schedule-modal-backdrop.open{
      display:flex;
    }
    .schedule-modal{
      position:relative;
      background:#10101b;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      max-width:420px;
      width:90%;
      padding:16px 18px 14px;
      box-shadow:0 18px 40px rgba(0,0,0,.75);
    }
    .schedule-modal-close{
      position:absolute;
      top:8px;
      right:10px;
      border:none;
      background:transparent;
      color:#d7d7e2;
      font-size:18px;
      cursor:pointer;
    }
    .schedule-modal h2{
      margin:0 24px 8px 0;
      font-size:1.05rem;
    }
    .schedule-modal-details{
      margin:0;
      padding:0;
    }
    .schedule-modal-details-row{
      display:flex;
      justify-content:space-between;
      gap:12px;
      font-size:.86rem;
      margin-bottom:4px;
    }
    .schedule-modal-details-row dt{
      font-weight:bold;
      color:#c7c7d8;
    }
    .schedule-modal-details-row dd{
      margin:0;
      text-align:right;
      color:#f5f5ff;
      white-space:pre-wrap;
    }

    /* Mobile tweaks */
    @media(max-width:720px){
      .page-shell{
        padding:20px 16px 32px;
      }
      .page-header{
        flex-direction:column;
        align-items:flex-start;
        gap:12px;
      }
      .record-card,
      .live-card{
        width:100%;
      }
      .filter-toolbar{
        gap:6px;
      }
    }
  </style>

  <!-- Dynamic meta + data loader -->
  <script>
    (function(){
      const params = new URLSearchParams(window.location.search);

      const teamId   = params.get('team')       || 'marauders12u';
      const teamName = params.get('name')       || 'Marauders 12U';
      const flushIcs = params.get('flushIcs')   || false;

      const fullTitle = `${teamName} Schedule | NJ Hitz Softball`;
      document.title = fullTitle;

      function setMeta(property, content, isProperty){
        const selector = isProperty
          ? `meta[property="${property}"]`
          : `meta[name="${property}"]`;
        let el = document.querySelector(selector);
        if(!el){
          el = document.createElement('meta');
          if(isProperty) el.setAttribute('property', property);
          else el.setAttribute('name', property);
          document.head.appendChild(el);
        }
        el.setAttribute('content', content);
      }

      const canonicalUrl = `https://njhitz.org/schedule?team=${encodeURIComponent(teamId)}`;

      const metaConfig = {
        description: `Live schedule, results, and record for ${teamName} powered by GameChanger.`,
        'og:type': 'website',
        'og:title': fullTitle,
        'og:description': `Follow every game for ${teamName} with automatic updates powered by GameChanger.`,
        'og:url': canonicalUrl,
        'og:image': 'https://njhitz.org/images/hitz-meta-og.png',
        'twitter:card': 'summary_large_image',
        'twitter:title': fullTitle,
        'twitter:description': `Live schedule and record for ${teamName}.`,
        'twitter:image': 'https://njhitz.org/images/hitz-meta-og.png'
      };

      Object.entries(metaConfig).forEach(([key,value]) => {
        const isProperty = key.startsWith('og:') || key.startsWith('twitter:');
        setMeta(key, value, isProperty);
      });

      window.__GC_SCHEDULE_CONFIG__ = {
        teamId,
        teamName,
        flushIcs
      };
    })();
  </script>
</head>

<body>
  <header class="site-header">
    <div id="header"></div>
  </header>

  <main class="page-shell">
    <section class="page-header">
      <div>
        <h1 class="page-title" id="schedule-team-title">Team Schedule</h1>
        <p class="page-subtitle" id="schedule-team-subtitle">
          Live schedule, results, and record powered by GameChanger.
        </p>
      </div>

      <!-- NEW LIVE SUMMARY CARD -->
      <a href="" target="_blank" class="live-card-link" id="live-card-link">
        <aside class="live-card" id="live-card">
                <div class="live-label">
                    <span id="live-label-video" class="live-label-video" style="display:none;"><svg data-testid="video-camera-outline-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.2413 4H6.7587C5.95374 3.99999 5.28937 3.99998 4.74818 4.04419C4.18608 4.09012 3.66937 4.18868 3.18404 4.43598C2.43139 4.81947 1.81947 5.43139 1.43598 6.18404C1.18868 6.66937 1.09012 7.18608 1.04419 7.74818C0.999978 8.28937 0.999988 8.95372 1 9.75869V14.2413C0.999988 15.0463 0.999978 15.7106 1.04419 16.2518C1.09012 16.8139 1.18868 17.3306 1.43598 17.816C1.81947 18.5686 2.43139 19.1805 3.18404 19.564C3.66937 19.8113 4.18608 19.9099 4.74818 19.9558C5.28937 20 5.95373 20 6.7587 20H12.2413C13.0462 20 13.7106 20 14.2518 19.9558C14.8139 19.9099 15.3306 19.8113 15.816 19.564C16.5686 19.1805 17.1805 18.5686 17.564 17.816C17.8113 17.3306 17.9099 16.8139 17.9558 16.2518C17.9968 15.7499 17.9998 15.1419 18 14.4141L19.9535 16.3677C20.1447 16.5589 20.3326 16.7468 20.4973 16.8847C20.6442 17.0078 20.9537 17.2545 21.3823 17.2882C21.861 17.3259 22.3288 17.1321 22.6406 16.767C22.9198 16.4401 22.9642 16.0468 22.9811 15.8559C23.0001 15.6419 23 15.3762 23 15.1058V8.89407C23 8.6237 23.0001 8.35792 22.9811 8.14396C22.9642 7.95307 22.9198 7.55981 22.6406 7.23287C22.3288 6.86775 21.861 6.67399 21.3823 6.71166C20.9537 6.7454 20.6442 6.99211 20.4973 7.11512C20.3326 7.253 20.1447 7.44093 19.9536 7.63213L18 9.58573C17.9998 8.85799 17.9968 8.25011 17.9558 7.74818C17.9099 7.18608 17.8113 6.66937 17.564 6.18404C17.1805 5.43139 16.5686 4.81947 15.816 4.43598C15.3306 4.18868 14.8139 4.09012 14.2518 4.04419C13.7106 3.99998 13.0463 3.99999 12.2413 4ZM8.21317 8.50287C7.82898 8.53305 7.48529 8.72197 7.25965 9.02424C7.00867 9.36161 7 9.4563 7 10.1424L7.00018 13.9749C7.00263 14.4728 7.02833 14.6685 7.26219 14.979C7.48296 15.279 7.83285 15.4713 8.21574 15.4972C8.59304 15.5274 8.69833 15.4914 9.1587 15.1967L12.1652 13.252C12.6644 12.9279 12.7462 12.8635 12.8962 12.5108C13.0341 12.1833 13.0341 11.8175 12.8976 11.4934C12.7462 11.1373 12.6644 11.073 12.1666 10.7497L9.29318 8.89081C8.71952 8.51934 8.63207 8.47355 8.21317 8.50287Z" fill="white"></path></svg></span>
                    <span class="live-label-live">LIVE</span>
                </div>
                <div class="live-opponent" id="live-opponent">No live game</div>
                <div class="live-score" id="live-score"></div>
        </aside>
      </a>

      <aside class="record-card">
        <div class="record-label">Record</div>
        <div class="record-value" id="schedule-record">–</div>
        <div class="record-meta" id="schedule-record-meta">Based on completed games</div>
      </aside>
    </section>

    <section class="schedule-section">
      <div class="schedule-status" id="schedule-status">
        Loading schedule…
      </div>

      <!-- Top filter toolbar -->
      <div class="filter-toolbar">
        <button type="button" class="filter-chip filter-toggle" data-filter="opponent">
          <span>Opponent</span>
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M4 5h16l-6 7.5V19l-4-2v-4.5L4 5z"/>
          </svg>
        </button>

        <button type="button" class="filter-chip filter-toggle" data-filter="type">
          <span>Type</span>
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M4 5h16l-6 7.5V19l-4-2v-4.5L4 5z"/>
          </svg>
        </button>

        <label class="hide-past-toggle">
          <input type="checkbox" id="hide-past-events">
          <span>Hide past events</span>
        </label>
      </div>

      <!-- Mobile-only list (JS will toggle visibility) -->
      <div class="schedule-mobile" id="schedule-mobile" style="display:none;">
        <ul class="schedule-mobile-list" id="schedule-mobile-list"></ul>
      </div>

      <!-- Desktop table (JS will toggle visibility) -->
      <div class="schedule-table-wrapper" id="schedule-table-wrapper" style="display:none;">
        <table class="schedule-table">
          <thead>
            <tr>
              <th style="width:16%;">Date</th>
              <th style="width:12%;">Time</th>
              <th id="th-opponent" style="width:28%;">
                <div class="th-label">
                  <span>Opponent</span>
                  <button type="button" class="filter-toggle" data-filter="opponent" aria-label="Filter by opponent">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path fill="currentColor" d="M4 5h16l-6 7.5V19l-4-2v-4.5L4 5z"/>
                    </svg>
                  </button>
                </div>
              </th>
              <th id="th-type" style="width:12%;">
                <div class="th-label">
                  <span>Type</span>
                  <button type="button" class="filter-toggle" data-filter="type" aria-label="Filter by type">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path fill="currentColor" d="M4 5h16l-6 7.5V19l-4-2v-4.5L4 5z"/>
                    </svg>
                  </button>
                </div>
              </th>
              <th style="width:20%;">Location</th>
              <th style="width:12%;">Result</th>
            </tr>
          </thead>
          <tbody id="schedule-body"></tbody>
        </table>

        <!-- Opponent Filter Panel -->
        <div class="filter-panel" id="filter-panel-opponent">
          <div class="filter-panel-header">
            <span>Filter Opponent</span>
            <button class="filter-panel-close" data-close="opponent">&times;</button>
          </div>
          <div class="filter-panel-body">
            <div class="filter-actions">
              <button type="button" id="filter-opponent-select-all">Select all</button>
              <button type="button" id="filter-opponent-clear">Clear</button>
            </div>
            <input type="text" id="filter-opponent-search" placeholder="Search opponents">
            <div class="filter-options" id="filter-opponent-options"></div>
          </div>
        </div>

        <!-- Type Filter Panel -->
        <div class="filter-panel" id="filter-panel-type">
          <div class="filter-panel-header">
            <span>Filter Type</span>
            <button class="filter-panel-close" data-close="type">&times;</button>
          </div>
          <div class="filter-panel-body">
            <div class="filter-actions">
              <button type="button" id="filter-type-select-all">Select all</button>
              <button type="button" id="filter-type-clear">Clear</button>
            </div>
            <div class="filter-options" id="filter-type-options">
              <label class="filter-option">
                <input type="checkbox" value="game" checked>
                <span>Game</span>
              </label>
              <label class="filter-option">
                <input type="checkbox" value="practice" checked>
                <span>Practice</span>
              </label>
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <!-- Modal for event details (mobile & desktop) -->
  <div class="schedule-modal-backdrop" id="schedule-modal" aria-hidden="true">
    <div class="schedule-modal" role="dialog" aria-modal="true" aria-labelledby="schedule-modal-title">
      <button type="button" class="schedule-modal-close" id="schedule-modal-close" aria-label="Close details">&times;</button>
      <h2 id="schedule-modal-title">Event details</h2>
      <dl class="schedule-modal-details" id="schedule-modal-body"></dl>
    </div>
  </div>

  <footer class="site-footer">
    <div id="footer"></div>
  </footer>

  <script src="scripts/preload.js"></script>

  <script>
    (function(){
      const cfg = window.__GC_SCHEDULE_CONFIG__ || {};
      const teamName = cfg.teamName || 'NJ Hitz Team';
      const levelLabel = cfg.levelLabel || '';
      const headerTitle = document.getElementById('schedule-team-title');
      const headerSubtitle = document.getElementById('schedule-team-subtitle');

      headerTitle.textContent = `${teamName} Schedule`;
      headerSubtitle.textContent = levelLabel
        ? `${levelLabel} · Live schedule, results, and record powered by GameChanger.`
        : `Live schedule, results, and record powered by GameChanger.`;

      const statusEl  = document.getElementById('schedule-status');
      const bodyEl    = document.getElementById('schedule-body');
      const tableWrap = document.getElementById('schedule-table-wrapper');
      const mobileContainer = document.getElementById('schedule-mobile');
      const mobileListEl = document.getElementById('schedule-mobile-list');
      const recordEl  = document.getElementById('schedule-record');
      const recordMetaEl = document.getElementById('schedule-record-meta');

      const thOpponent = document.getElementById('th-opponent');
      const thType = document.getElementById('th-type');

      const panelOpponent = document.getElementById('filter-panel-opponent');
      const panelType = document.getElementById('filter-panel-type');
      const opponentSearchInput = document.getElementById('filter-opponent-search');
      const opponentOptionsEl = document.getElementById('filter-opponent-options');
      const typeOptionsEl = document.getElementById('filter-type-options');

      const opponentSelectAllBtn = document.getElementById('filter-opponent-select-all');
      const opponentClearBtn = document.getElementById('filter-opponent-clear');
      const typeSelectAllBtn = document.getElementById('filter-type-select-all');
      const typeClearBtn = document.getElementById('filter-type-clear');

      const hidePastCheckbox = document.getElementById('hide-past-events');
      const HIDE_PAST_KEY = 'scheduleHidePastEvents';

      const modal = document.getElementById('schedule-modal');
      const modalBody = document.getElementById('schedule-modal-body');
      const modalTitle = document.getElementById('schedule-modal-title');
      const modalClose = document.getElementById('schedule-modal-close');

      const liveCard = document.getElementById('live-card');
      const liveCardLink = document.getElementById('live-card-link');
      const liveCardVideo = document.getElementById('live-label-video');
      const liveOpponentEl = document.getElementById('live-opponent');
      const liveScoreEl = document.getElementById('live-score');

      let allOpponents = [];
      let selectedOpponents = new Set();
      let opponentFilterActive = false;

      let selectedTypes = new Set(['game','practice']);
      let typeFilterActive = false;

      let hidePastActive = false;

      // Live polling state (adjust interval as needed)
      const LIVE_POLL_INTERVAL_MS = 10000;
      let livePollTimer = null;
      let livePollGcTeamId = null;
      let liveActiveInfo = null;
      let lastLiveScore = null;

      // GAS web app endpoint
      const ENDPOINT = 'https://script.google.com/macros/s/AKfycbx0iCzaMgXMkUpUxHswi1klKNpOISdMHja_xFbkY4UkT2c8T8Hhy54ZaR9sJ1luPx0M/exec';

      const query = new URLSearchParams({
        team: window.__GC_SCHEDULE_CONFIG__.teamId,
        flushIcs: window.__GC_SCHEDULE_CONFIG__.flushIcs
      });

      function isMobileViewport() {
        return window.matchMedia && window.matchMedia('(max-width: 720px)').matches;
      }

      function formatDate(dateStr){
        if(!dateStr) return '';
        const d = new Date(dateStr);
        if(isNaN(d.getTime())) return dateStr;
        return d.toLocaleDateString(undefined, {month:'short', day:'numeric'});
      }

      function formatTime(timeStr){
        if(!timeStr) return '';
        if(/[ap]m/i.test(timeStr)) return timeStr;
        const parts = timeStr.split(':');
        if(parts.length < 2) return timeStr;
        let h = parseInt(parts[0],10);
        const m = parts[1];
        if(isNaN(h)) return timeStr;
        const ampm = h >= 12 ? 'PM':'AM';
        h = ((h + 11) % 12) + 1;
        return `${h}:${m} ${ampm}`;
      }

      // Clean up locations (handles \n, real newlines, and escaped commas)
      function sanitizeLocation(value){
        if (!value) return '';
        let cleaned = String(value);
        cleaned = cleaned.replace(/\\n/g, ', ').replace(/\n/g, ', ');
        cleaned = cleaned.replace(/\\,/g, ',');
        cleaned = cleaned.replace(/\s+/g, ' ');
        return cleaned.trim();
      }

      // Strip leading "vs " or "@ " to get the bare opponent name
      function getOpponentName(opponentDisplay){
        const s = (opponentDisplay || '').trim();
        if (!s) return '';
        const m = s.match(/^(vs|@)\s+(.+)$/i);
        if (m) return m[2].trim();
        return s;
      }

      // Desktop & mobile live result HTML builders
      function buildLiveResultHtmlDesktop(teamScore, oppScore){
        const ts = (typeof teamScore === 'number') ? teamScore : 0;
        const os = (typeof oppScore === 'number') ? oppScore : 0;
        return `<span class="live-badge">Live</span> <span class="score live-score-desktop"><span class="live-score-team">${ts}</span> - <span class="live-score-opp">${os}</span></span>`;
      }

      function buildLiveResultHtmlMobile(teamScore, oppScore){
        const ts = (typeof teamScore === 'number') ? teamScore : 0;
        const os = (typeof oppScore === 'number') ? oppScore : 0;
        return `<span class="live-badge">Live</span> <span class="score live-score-mobile"><span class="live-score-team">${ts}</span> - <span class="live-score-opp">${os}</span></span>`;
      }

      function applyFilters(){
        const now = new Date();
        const rows = bodyEl.querySelectorAll('tr');
        const cards = mobileListEl ? mobileListEl.querySelectorAll('.schedule-mobile-item') : [];

        function visible(el){
          const rowOppName = (el.dataset.opponentName || '');
          const rowType = (el.dataset.type || '');
          const dateStr = el.dataset.date || '';
          const isLive = el.dataset.isLive === '1';

          let isPast = false;
          if(dateStr){
            const d = new Date(dateStr);
            if(!isNaN(d.getTime()) && d < now && !isLive) isPast = true; // LIVE not treated as past
          }

          const oppMatch = !opponentFilterActive || selectedOpponents.has(rowOppName);
          const typeMatch = !typeFilterActive || selectedTypes.has(rowType);
          const pastMatch = !hidePastActive || !isPast;

          return oppMatch && typeMatch && pastMatch;
        }

        rows.forEach(row => {
          row.style.display = visible(row) ? '' : 'none';
        });
        cards.forEach(card => {
          card.style.display = visible(card) ? '' : 'none';
        });
      }

      function positionPanel(panel, anchorEl){
        const rect = anchorEl.getBoundingClientRect();
        panel.style.left = Math.round(rect.left + window.scrollX) + 'px';
        panel.style.top  = Math.round(rect.bottom + window.scrollY + 4) + 'px';
      }

      function openPanel(which, anchorEl){
        closePanels();
        if(which === 'opponent'){
          positionPanel(panelOpponent, anchorEl || thOpponent);
          panelOpponent.style.display = 'block';
        } else if(which === 'type'){
          positionPanel(panelType, anchorEl || thType);
          panelType.style.display = 'block';
        }
      }

      function closePanels(){
        panelOpponent.style.display = 'none';
        panelType.style.display = 'none';
      }

      function recomputeOpponentSelection(){
        const inputs = opponentOptionsEl.querySelectorAll('input[type="checkbox"]');
        const checkedValues = [];
        const allValues = [];
        inputs.forEach(inp => {
          allValues.push(inp.value);
          if(inp.checked) checkedValues.push(inp.value);
        });

        selectedOpponents.clear();
        if(checkedValues.length === 0 || checkedValues.length === allValues.length){
          opponentFilterActive = false;
        } else {
          opponentFilterActive = true;
          checkedValues.forEach(v => selectedOpponents.add(v));
        }
        applyFilters();
      }

      function recomputeTypeSelection(){
        const inputs = typeOptionsEl.querySelectorAll('input[type="checkbox"]');
        const checkedValues = [];
        const allValues = [];
        inputs.forEach(inp => {
          allValues.push(inp.value);
          if(inp.checked) checkedValues.push(inp.value);
        });

        selectedTypes.clear();
        if(checkedValues.length === 0 || checkedValues.length === allValues.length){
          typeFilterActive = false;
        } else {
          typeFilterActive = true;
          checkedValues.forEach(v => selectedTypes.add(v));
        }
        applyFilters();
      }

      function buildOpponentFilter(events){
        const set = new Set();
        events.forEach(evt => {
          const oppName = getOpponentName(evt.opponent || '');
          if(oppName) set.add(oppName);
        });
        allOpponents = Array.from(set).sort((a,b) => a.localeCompare(b));

        opponentOptionsEl.innerHTML = '';
        allOpponents.forEach(name => {
          const row = document.createElement('label');
          row.className = 'filter-option';
          const input = document.createElement('input');
          input.type = 'checkbox';
          input.value = name.toLowerCase();
          input.checked = true;
          const span = document.createElement('span');
          span.textContent = name;
          row.appendChild(input);
          row.appendChild(span);
          opponentOptionsEl.appendChild(row);
        });

        selectedOpponents.clear();
        opponentFilterActive = false;

        opponentOptionsEl.addEventListener('change', recomputeOpponentSelection);

        opponentSearchInput.addEventListener('input', () => {
          const term = opponentSearchInput.value.trim().toLowerCase();
          const labels = opponentOptionsEl.querySelectorAll('.filter-option');
          labels.forEach(label => {
            const text = label.querySelector('span').textContent.toLowerCase();
            label.style.display = !term || text.indexOf(term) !== -1 ? '' : 'none';
          });
        });
      }

      function initTypeFilter(){
        typeOptionsEl.addEventListener('change', recomputeTypeSelection);
      }

      function attachFilterToggles(){
        const toggles = document.querySelectorAll('.filter-toggle');
        toggles.forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const which = btn.dataset.filter;
            if(which === 'opponent'){
              if(panelOpponent.style.display === 'block') closePanels();
              else openPanel('opponent', btn);
            } else if(which === 'type'){
              if(panelType.style.display === 'block') closePanels();
              else openPanel('type', btn);
            }
          });
        });

        document.querySelectorAll('.filter-panel-close').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            closePanels();
          });
        });

        document.addEventListener('click', (e) => {
          if(!panelOpponent.contains(e.target) && !panelType.contains(e.target) &&
             !thOpponent.contains(e.target) && !thType.contains(e.target)) {
            closePanels();
          }
        });

        if (opponentSelectAllBtn && opponentClearBtn) {
          opponentSelectAllBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const inputs = opponentOptionsEl.querySelectorAll('input[type="checkbox"]');
            inputs.forEach(inp => inp.checked = true);
            recomputeOpponentSelection();
          });
          opponentClearBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const inputs = opponentOptionsEl.querySelectorAll('input[type="checkbox"]');
            inputs.forEach(inp => inp.checked = false);
            recomputeOpponentSelection();
          });
        }

        if (typeSelectAllBtn && typeClearBtn) {
          typeSelectAllBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const inputs = typeOptionsEl.querySelectorAll('input[type="checkbox"]');
            inputs.forEach(inp => inp.checked = true);
            recomputeTypeSelection();
          });
          typeClearBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const inputs = typeOptionsEl.querySelectorAll('input[type="checkbox"]');
            inputs.forEach(inp => inp.checked = false);
            recomputeTypeSelection();
          });
        }
      }

      function initHidePastFilter(){
        try {
          const saved = localStorage.getItem(HIDE_PAST_KEY);
          hidePastActive = (saved === '1');
        } catch(e){
          hidePastActive = false;
        }
        if(hidePastCheckbox){
          hidePastCheckbox.checked = hidePastActive;
          hidePastCheckbox.addEventListener('change', () => {
            hidePastActive = hidePastCheckbox.checked;
            try {
              localStorage.setItem(HIDE_PAST_KEY, hidePastActive ? '1' : '0');
            } catch(e){}
            applyFilters();
          });
        }
      }

      function openModal(detail){
        if(!modal) return;
        modalTitle.textContent = detail.opponent || 'Event details';

        const rows = [];
        if(detail.date){
          rows.push({label:'Date', value:detail.date});
        }
        if(detail.time){
          rows.push({label:'Time', value:detail.time});
        }
        if(detail.type){
          rows.push({label:'Type', value:detail.type});
        }
        if(detail.location){
          rows.push({label:'Location', value:detail.location});
        }
        if(detail.resultText){
          rows.push({label:'Result', value:detail.resultText});
        }
        if(detail.status && detail.status !== detail.resultText){
          rows.push({label:'Status', value:detail.status});
        }

        modalBody.innerHTML = rows.map(r => `
          <div class="schedule-modal-details-row">
            <dt>${r.label}</dt>
            <dd>${r.value}</dd>
          </div>
        `).join('');

        modal.classList.add('open');
        modal.setAttribute('aria-hidden','false');
      }

      function closeModal(){
        if(!modal) return;
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden','true');
      }

      if(modalClose){
        modalClose.addEventListener('click', (e) => {
          e.stopPropagation();
          closeModal();
        });
      }
      if(modal){
        modal.addEventListener('click', (e) => {
          if(e.target === modal){
            closeModal();
          }
        });
      }
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape'){
          closeModal();
        }
      });

      function stopLivePolling(){
        if(livePollTimer){
          clearInterval(livePollTimer);
          livePollTimer = null;
        }
        livePollGcTeamId = null;
        liveActiveInfo = null;
      }

      function updateLiveScoreUi(liveInfo, teamScore, oppScore){
        if(!liveInfo) return;
        const scoreText = `${teamScore} - ${oppScore}`;

        if(liveScoreEl){
          liveScoreEl.textContent = scoreText;
          liveScoreEl.classList.add('score-animate');
          setTimeout(() => liveScoreEl.classList.remove('score-animate'), 550);
        }

        if(liveInfo.desktopResultCell){
          liveInfo.desktopResultCell.innerHTML = buildLiveResultHtmlDesktop(teamScore, oppScore);
          const wrap = liveInfo.desktopResultCell.querySelector('.live-score-desktop');
          if(wrap){
            wrap.classList.add('score-animate');
            setTimeout(() => wrap.classList.remove('score-animate'), 550);
          }
        }

        if(liveInfo.mobilePrimaryEl){
          liveInfo.mobilePrimaryEl.innerHTML = buildLiveResultHtmlMobile(teamScore, oppScore);
          const wrap = liveInfo.mobilePrimaryEl.querySelector('.live-score-mobile');
          if(wrap){
            wrap.classList.add('score-animate');
            setTimeout(() => wrap.classList.remove('score-animate'), 550);
          }
        }
      }

      function startLivePolling(gcTeamId, liveInfo){
        if(!gcTeamId || !liveInfo) return;
        stopLivePolling();
        livePollGcTeamId = gcTeamId;
        liveActiveInfo = liveInfo;
        if(typeof liveInfo.teamScore === 'number' && typeof liveInfo.oppScore === 'number'){
            lastLiveScore = {team: liveInfo.teamScore, opp: liveInfo.oppScore};
        } else {
            lastLiveScore = null;
        }

        const url = `${ENDPOINT}?mode=live&gcTeamId=${encodeURIComponent(gcTeamId)}`;

        const poll = () => {
            fetch(url)       // <-- no more mode: 'no-cors'
            .then(resp => {
                if (!resp.ok) {
                throw new Error('Live proxy error: ' + resp.status);
                }
                return resp.json();
            })
            .then(data => {
                if (!data) return;

                // If your Apps Script returns { status: 404 } when no live game:
                if (data.status === 404) {
                    stopLivePolling();
                    liveCard.style.display = 'none';
                    return;
                }

                const score = data.score || {};
                const teamScore = (typeof score.team === 'number') ? score.team : null;
                const oppScore  = (typeof score.opponent_team === 'number') ? score.opponent_team : null;
                if (teamScore === null || oppScore === null) return;

                if (!lastLiveScore ||
                    lastLiveScore.team !== teamScore ||
                    lastLiveScore.opp  !== oppScore) {
                lastLiveScore = {team: teamScore, opp: oppScore};
                updateLiveScoreUi(liveActiveInfo, teamScore, oppScore);
                }
            })
            .catch(err => {
                console.error(err);
            });
        };

        poll();
        livePollTimer = setInterval(poll, LIVE_POLL_INTERVAL_MS);
        }


      function loadSchedule(){
        statusEl.textContent = 'Loading schedule…';

        fetch(`${ENDPOINT}?${query.toString()}`)
          .then(resp => {
            if(!resp.ok) throw new Error('Network error: ' + resp.status);
            return resp.json();
          })
          .then(data => {
            const events = (data && data.events) ? data.events : [];
            if(data && data.teamName){
              headerTitle.textContent = `${data.teamName} Schedule`;
            }
            if(!events.length){
              statusEl.textContent = 'No scheduled events found yet.';
              tableWrap.style.display = 'none';
              if(mobileContainer) mobileContainer.style.display = 'none';
              recordEl.textContent = '0-0';
              recordMetaEl.textContent = 'No completed games yet.';
              liveCard.style.display = 'none';
              stopLivePolling();
              return;
            }

            events.sort((a,b) => {
              const da = new Date(a.date || a.start || a.startDate || 0).getTime();
              const db = new Date(b.date || b.start || b.startDate || 0).getTime();
              return da - db;
            });

            let wins = 0, losses = 0, ties = 0;
            const now = new Date();
            let firstLive = null;

            bodyEl.innerHTML = '';
            if(mobileListEl) mobileListEl.innerHTML = '';

            events.forEach(evt => {
              const rawDate = evt.date || evt.startDate || evt.start;
              if (!rawDate) return;

              const eventDate = new Date(rawDate);
              const isPast = !isNaN(eventDate.getTime()) && eventDate < now;
              const dateIso = !isNaN(eventDate.getTime()) ? eventDate.toISOString() : '';

              const dateDisplay = evt.dateDisplay || formatDate(rawDate);
              const timeDisplay = evt.timeDisplay || formatTime(evt.time || evt.startTime || '');

              const opponentDisplay = evt.opponent || evt.opponentName || '';
              const opponentName = getOpponentName(opponentDisplay);

              const typeRaw = evt.type || evt.eventType || evt.kind || '';
              const type     = typeRaw;
              const locationRaw = evt.location || evt.field || '';
              const location = sanitizeLocation(locationRaw);

              const typeNorm = (type || '').toLowerCase();
              const isGame     = typeNorm === 'game';
              const isPractice = typeNorm === 'practice';
              const isEvent    = typeNorm === 'event';

              const isComplete = !!evt.isComplete ||
                                 evt.status === 'Final' ||
                                 evt.status === 'Completed' ||
                                 evt.status === 'Done';

              const isLive = evt.isLive === true ||
                             evt.isLive === 'true' ||
                             (evt.status && evt.status.toLowerCase() === 'live') ||
                             (evt.gameStatus && String(evt.gameStatus).toLowerCase() === 'live');
              const gameUrl = evt.gameUrl || '';

              let result = evt.result || '';
              const ts = evt.teamScore;
              const os = evt.oppScore;
              let scoreText = '';
              const isScored = (typeof ts === 'number' && typeof os === 'number');

              if (isScored){
                scoreText = `${ts} - ${os}`;
                if(!result && isComplete){
                  if(ts > os) result = 'W';
                  else if(ts < os) result = 'L';
                  else result = 'T';
                }
              }

              if(isGame && isComplete && !isLive && result){
                if(result === 'W') wins++;
                else if(result === 'L') losses++;
                else if(result === 'T') ties++;
              }

              let resultHtml = '';
              const status = evt.status || '';
              const isCanceled = false; //isGame && !isLive && !isScored && isPast; //REMOVING CANCELED LOGIC

              if (isGame) {
                if (isLive) {
                  if (isScored) {
                    resultHtml = buildLiveResultHtmlDesktop(ts, os);
                  } else {
                    resultHtml = `<span class="live-badge">Live</span>`;
                  }
                } else if (isScored && result) {
                  resultHtml = `<span class="result result-${result}">${result}</span> <span class="score">${scoreText}</span>`;
                } else if (isCanceled) {
                  resultHtml = 'Canceled';
                } else if (evt.status) {
                  resultHtml = evt.status;
                }
              } else {
                if (isLive) {
                  if (isScored && result) {
                    resultHtml = `<span class="result result-${result}">${result}</span> <span class="score">${scoreText}</span>`;
                  } else if (isScored) {
                    resultHtml = buildLiveResultHtmlDesktop(ts, os);
                  } else {
                    resultHtml = `<span class="live-badge">Live</span>`;
                  }
                } else if (isScored && result) {
                  resultHtml = `<span class="result result-${result}">${result}</span> <span class="score">${scoreText}</span>`;
                } else {
                  resultHtml = '';
                }
              }

              // DESKTOP ROW
              const tr = document.createElement('tr');
              tr.dataset.opponent = opponentDisplay.toLowerCase();
              tr.dataset.opponentName = opponentName.toLowerCase();
              tr.dataset.type = typeNorm;
              tr.dataset.date = dateIso;
              tr.dataset.isLive = isLive ? '1' : '0';
              if (isLive) tr.classList.add('live-row');

              tr.innerHTML = `
                <td data-label="Date">${dateDisplay || ''}</td>
                <td data-label="Time">${timeDisplay || ''}</td>
                <td data-label="Opponent">${opponentDisplay || ''}</td>
                <td data-label="Type">${type || ''}</td>
                <td data-label="Location">${location || ''}</td>
                <td data-label="Result">
                  ${resultHtml}
                </td>
              `;
              bodyEl.appendChild(tr);

              // MOBILE CARD
              let mobileItemRef = null;
              if(mobileListEl){
                const li = document.createElement('li');
                li.className = 'schedule-mobile-item';
                li.dataset.opponentName = opponentName.toLowerCase();
                li.dataset.type = typeNorm;
                li.dataset.date = dateIso;
                li.dataset.isLive = isLive ? '1' : '0';
                if (isLive) li.classList.add('live-row');

                const hasOutcome = isLive || (isScored && result) || isCanceled;
                let primaryLabelHtml = '';
                let resultTextForModal = '';

                if(hasOutcome){
                  if (isLive) {
                    if (isScored) {
                      primaryLabelHtml = buildLiveResultHtmlMobile(ts, os);
                      resultTextForModal = `Live ${ts} - ${os}`;
                    } else {
                      const badge = `<span class="live-badge">Live</span>`;
                      primaryLabelHtml = badge;
                      resultTextForModal = 'Live';
                    }
                  } else if (isCanceled) {
                    const badge = `<span class="result">Canceled</span>`;
                    primaryLabelHtml = badge;
                    resultTextForModal = 'Canceled';
                  } else {
                    const badge = `<span class="result result-${result}">${result}</span>`;
                    const scorePart = scoreText ? `<span class="score">${scoreText}</span>` : '';
                    primaryLabelHtml = `${badge} ${scorePart}`.trim();
                    resultTextForModal = `${result}${scoreText ? ' ' + scoreText : ''}`;
                  }
                } else {
                  primaryLabelHtml = [dateDisplay, timeDisplay].filter(Boolean).join(' • ');
                  resultTextForModal = scoreText && result ? `${result} ${scoreText}` : (scoreText || '');
                }

                li.innerHTML = `
                  <button type="button" class="schedule-mobile-btn">
                    <div class="schedule-mobile-main">
                      <div class="schedule-mobile-primary"></div>
                      <div class="schedule-mobile-opponent">${opponentDisplay || ''}</div>
                    </div>
                    <div class="schedule-mobile-arrow">›</div>
                  </button>
                `;
                const primaryDiv = li.querySelector('.schedule-mobile-primary');
                primaryDiv.innerHTML = primaryLabelHtml || '&nbsp;';

                li.__detail = {
                  date: dateDisplay || '',
                  time: timeDisplay || '',
                  opponent: opponentDisplay || '',
                  type: type || '',
                  location: location || '',
                  resultText: resultTextForModal || (isCanceled ? 'Canceled' : ''),
                  status: isLive ? 'Live' : (isCanceled ? 'Canceled' : status || ''),
                };

                li.addEventListener('click', () => openModal(li.__detail));
                mobileListEl.appendChild(li);
                mobileItemRef = li;
              }

              // Track first LIVE game for hero card & polling
              if (isLive && isGame && !firstLive) {
                const desktopResultCell = tr.querySelector('td[data-label="Result"]');
                const mobilePrimaryEl = mobileItemRef ? mobileItemRef.querySelector('.schedule-mobile-primary') : null;
                firstLive = {
                  opponent: opponentDisplay || '',
                  scoreText: scoreText || '',
                  gameUrl: gameUrl,
                  desktopRow: tr,
                  desktopResultCell,
                  mobileItem: mobileItemRef || null,
                  mobilePrimaryEl,
                  teamScore: isScored ? ts : null,
                  oppScore: isScored ? os : null
                };
              }
            });

            const gamesCount = wins + losses + ties;
            recordEl.textContent = `${wins}-${losses}${ties ? '-' + ties : ''}`;
            recordMetaEl.textContent = gamesCount
              ? `Based on ${gamesCount} completed game${gamesCount !== 1 ? 's':''}.`
              : `No completed games yet.`;

            // LIVE hero card
            if (firstLive) {
              liveOpponentEl.textContent = firstLive.opponent || 'In progress';
              liveScoreEl.textContent = firstLive.scoreText || '';
              liveCard.style.display = 'block';
              if(data.liveEvent && data.liveEvent.video_stream){
                liveCardVideo.style.display = 'initial';
                liveCardLink.href = data.gcUrl || firstLive.gameUrl || '';
              } else {
                liveCardLink.href = firstLive.gameUrl || '';
              }
            } else {
              liveCard.style.display = 'none';
            }

            // Start polling GC live feed if a live game and gcTeamId present
            if (firstLive && data.gcTeamId) {
              startLivePolling(data.gcTeamId, firstLive);
            } else {
              stopLivePolling();
            }

            statusEl.style.display = 'none';

            // Only show one layout at a time based on viewport
            if (isMobileViewport()) {
              if(mobileContainer) mobileContainer.style.display = 'block';
              tableWrap.style.display = 'none';
            } else {
              tableWrap.style.display = 'block';
              if(mobileContainer) mobileContainer.style.display = 'none';
            }

            buildOpponentFilter(events);
            initTypeFilter();
            attachFilterToggles();
            applyFilters();
          })
          .catch(err => {
            console.error(err);
            statusEl.textContent = 'Unable to load schedule. Please try again later.';
            tableWrap.style.display = 'none';
            if(mobileContainer) mobileContainer.style.display = 'none';
            recordEl.textContent = '–';
            recordMetaEl.textContent = 'Record unavailable.';
            liveCard.style.display = 'none';
            stopLivePolling();
          });
      }

      initHidePastFilter();
      loadSchedule();

      // Respond to viewport changes
      window.addEventListener('resize', () => {
        if(!bodyEl.children.length) return;
        if (isMobileViewport()) {
          if(mobileContainer) mobileContainer.style.display = 'block';
          tableWrap.style.display = 'none';
        } else {
          tableWrap.style.display = 'block';
          if(mobileContainer) mobileContainer.style.display = 'none';
        }
      });
    })();
  </script>

  <script src="scripts/template-loader.js"></script>
</body>
</html>
